# =====================================================
# Windows Notepad Remediation Script
# Updates Microsoft Store Notepad to >= 11.2510
# Safe to run multiple times (idempotent)
# Exit 0 = compliant
# Exit 1 = failed / still non-compliant
# =====================================================

$MinimumVersion = [version]"11.2510.0"
$AppName = "Microsoft.WindowsNotepad"

function Get-NotepadVersion {
    $pkg = Get-AppxPackage -Name $AppName -AllUsers -ErrorAction SilentlyContinue
    if ($pkg) { return [version]$pkg.Version }
    return $null
}

Write-Output "Checking Notepad version..."

$current = Get-NotepadVersion

if ($current -and $current -ge $MinimumVersion) {
    Write-Output "Compliant. Current version: $current"
    exit 0
}

Write-Output "Non-compliant or missing. Attempting update..."

# Method 1 — Trigger Microsoft Store auto-update
Start-Process "ms-windows-store://downloadsandupdates" -ErrorAction SilentlyContinue

# Method 2 — Force Store update service
Get-Service InstallService -ErrorAction SilentlyContinue | Start-Service -ErrorAction SilentlyContinue

# Method 3 — winget upgrade (if deployed)
if (Get-Command winget -ErrorAction SilentlyContinue) {
    winget upgrade --id Microsoft.WindowsNotepad --silent --accept-source-agreements --accept-package-agreements
}

Start-Sleep -Seconds 5

$newVersion = Get-NotepadVersion

if ($newVersion -and $newVersion -ge $MinimumVersion) {
    Write-Output "Update successful. Version: $newVersion"
    exit 0
}
else {
    Write-Output "Update failed or still non-compliant. Version: $newVersion"
    exit 1
}